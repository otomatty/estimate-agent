# マイルストーン: 業務システム自動見積もりAIエージェント

**最終更新:** 2024-04-08 (改訂)

## 概要

このドキュメントでは、業務システム自動見積もりAIエージェントの開発マイルストーンを定義します。本システムはAPIとしてVercelにデプロイし、他のサービスから利用できるようにすることを前提としています。各フェーズの目標、期間、優先順位を明確にし、プロジェクトの進捗を管理します。

## マイルストーン一覧

### Phase 1: 環境構築・基盤開発・API設計 (2.5週間)

**目標:** 開発環境の構築、Supabaseセットアップ、API設計とMastra基盤の実装

- [x] Supabaseプロジェクト作成
- [x] データベーススキーマ実装 (`database_design.md` に基づく)
- [x] TypeScript API テスト環境の構築
- [x] Mastraプロジェクト初期化
- [x] Express + TypeScript APIプロジェクト設定
- [x] APIルーティングの基本設計
- [x] API認証機構の実装 (API Keyベース)
- [x] APIレート制限の実装
- [x] APIエラーハンドリング基盤の実装
- [x] Vercel用設定ファイルの作成
- [x] APIバージョニング戦略の決定と実装
- [ ] ユーザー認証フロー実装
- [ ] ユーザーアクティビティ記録の基盤実装

**進捗状況:**
- Supabaseプロジェクト「estimate-agent」を作成 (2024-04-07)
- データベーススキーマを完全実装、RLSポリシーを設定 (2024-04-07)
- TypeScriptを使用したテスト用アプリケーションを実装し、動作確認完了 (2024-04-08)
- CLIベースのフローテストを実装し、一連の見積もりプロセスの検証を完了 (2024-04-08)
- Express + TypeScript APIプロジェクトを設定し、基本構造を実装 (2024-04-08)
- APIルーティングの基本設計を完了し、ヘルスチェックエンドポイントを実装 (2024-04-08)
- API認証機構(API Keyベース)を実装 (2024-04-08)
- APIレート制限の実装を完了 (2024-04-08)
- APIエラーハンドリング基盤を実装 (2024-04-08)
- Vercel用設定ファイルを作成 (2024-04-08)
- APIバージョニング戦略を決定し実装 (2024-04-08)
- Express v5からExpress v4に変更（v5の互換性問題が発生したため） (2024-04-08)
- Supabaseテーブル（temporary_estimates, temporary_estimate_questions, temporary_estimate_items）のRLSを無効化し、APIが正常に動作するよう修正 (2024-04-08)

**問題点と解決策:**
- Express v5が実験的なバージョンで、path-to-regexpとの互換性問題が発生→Express v4に変更して解決
- SupabaseのテーブルにあるRow Level Security (RLS)設定が適切に構成されていなかった→匿名ユーザーでのアクセスのためRLSを無効化

**成果物:**
- 動作する開発環境
- API設計書
- APIエンドポイントの基本実装
- Supabaseスキーマが実装されたデータベース
- TypeScriptテスト用アプリケーション

**優先度:** 最高 (このフェーズなしで先に進めない)

### Phase 2: 初期要件入力・質問生成API実装 (2週間)

**目標:** 初期要件の受付とAIが質問リストを生成・返却するAPIの実装

- [x] 初期要件入力APIエンドポイント実装
- [x] AIエージェント (Mastra) の基本設定
- [x] `system_categories` テーブルの初期データ登録
- [x] `question_templates` テーブルの初期データ登録
- [x] 初期要件からシステムカテゴリを推定する機能の実装
- [x] エンベディング生成と保存ロジックの実装
- [x] 質問生成ワークフローの実装
- [x] API応答スキーマの設計と実装
- [ ] APIドキュメント作成
- [x] 質問取得APIの実装
- [x] 回答送信APIの実装
- [x] 匿名ユーザーのセッションデータ保持機能

**進捗状況:**
- 初期要件入力APIエンドポイントを実装 (2024-04-08)
- API応答スキーマの設計と実装 (2024-04-08)
- 質問取得APIの実装 (2024-04-08)
- 回答送信APIの実装 (2024-04-08)
- 匿名ユーザーのセッションデータ保持機能を実装 (2024-04-08)
- AIエージェント (Mastra) の基本設定を実装 (2024-04-09)
- `system_categories` テーブルと `question_templates` テーブルの初期データを登録 (2024-04-09)
- 初期要件からシステムカテゴリを推定する機能を実装 (2024-04-09)
- 質問生成ワークフローを実装 (2024-04-09)
- ワークフローを要件入力APIと統合 (2024-04-09)

**問題点と解決策:**
- 質問テンプレートデータがまだ不足しているため、質問生成が実質的に機能していない→サンプルデータをSupabaseに登録して解決
- Mastraのワークフローやツールの型エラーが発生→一部実装の詳細はデプロイして検証する必要あり

**成果物:**
- 初期要件入力から質問回答までのAPI一式
- 基本的なAIによる質問生成機能
- エンベディングを活用したRAG基盤
- APIドキュメント (OpenAPI仕様)

**優先度:** 高 (プロジェクトの中核機能)

### Phase 3: 機能洗い出し・コスト概算API実装 (3週間)

**目標:** ユーザーの回答に基づいて必要機能を洗い出し、コスト概算を行うAPIの実装

- [x] `project_templates` テーブルの初期データ登録
- [x] RAG機能の実装 (過去プロジェクトデータの参照)
    - [x] `system_categories` テーブルへの `content_embedding` カラム追加
    - [x] `match_projects`, `match_categories` PostgreSQL関数作成 (768次元 `text-embedding-004` 用)
    - [x] `ivfflat` インデックス作成 (`project_templates`, `system_categories`)
    - [x] エンベディング生成スクリプト作成 (`generate-embeddings.ts`, `generate-category-embeddings.ts`)
    - [x] `project_templates`, `system_categories` データへのエンベディング生成・保存完了 (`text-embedding-004` を使用)
        - *当初 `gemini-embedding-exp-03-07` (3000次元) を検討したが、Supabase のインデックス (ivfflat, hnsw) が2000次元までの制限のため、`text-embedding-004` (768次元) に変更*
    - [x] ドキュメント処理・チャンキング機能の実装 (`src/lib/rag/document.ts`)
    - [x] PostgreSQLベクトルストア操作ヘルパー実装 (`src/lib/rag/vector-store.ts`)
    - [x] RAGエージェントとカスタムベクトル検索ツール実装 (`src/lib/rag/index.ts`, `src/mastra/index.ts`)
    - [x] RAG用APIエンドポイント実装 (`src/api/routes/v1/rag.ts`)
    - [x] 基本的な動作確認とフィルター機能の確認完了
- [ ] 機能抽出ワークフローの実装
- [ ] コスト概算ロジックの実装
- [ ] 機能リスト取得APIの実装
- [ ] 見積もり項目更新APIの実装
- [ ] 精度検証とチューニング (RAG含む)
- [ ] API応答パフォーマンスの最適化
- [ ] API応答データの圧縮対応
- [ ] API利用サンプルコードの作成 (TypeScript, Python)
- [ ] 一時見積もりデータの永続化機能

**成果物:**
- 機能洗い出しと概算見積もり生成API
- RAG機能の基本実装完了
- API利用サンプルコード

**優先度:** 高 (見積もりの中核機能)

**注意点:** コスト概算の精度は継続的な改善が必要。初期バージョンでは人間による調整を前提とする。

### Phase 4: 機能選択・見積書出力API実装 (2.5週間)

**目標:** 機能選択と最終見積書をPDF出力するAPIの実装

- [ ] 機能選択更新APIの実装
- [ ] 選択機能に基づく合計金額計算機能の実装
- [ ] 見積書テンプレートデザインの作成
- [ ] PDFレンダリング機能の実装
- [ ] Supabaseストレージへの保存機能の実装
- [ ] PDF取得APIの実装
- [ ] 見積書メール送信APIの実装
- [ ] API結果キャッシュ戦略の実装
- [ ] 大容量データ転送の最適化

**成果物:**
- 機能選択から見積書生成までのAPI一式
- プロフェッショナルな見積書PDF生成API
- メール通知API

**優先度:** 高 (見積もりプロセス完了に必要)

### Phase 5: ビジネス分析APIの実装 (2.5週間)

**目標:** 見積もり結果に基づくビジネス的な価値分析APIの実装

- [ ] ROI計算アルゴリズムの実装
- [ ] コスト最適化分析機能の実装
- [ ] 業務効率化予測機能の実装
- [ ] 拡張性分析ロジックの実装
- [ ] 分析データ取得APIの実装
- [ ] チャートデータ生成ロジックの実装 (`charts_implementation.md` に基づく)
- [ ] 業界ベンチマークデータの初期登録
- [ ] ビジネス分析結果のJSON/CSV出力API実装

**成果物:**
- ビジネス分析データ提供API
- ビジネス価値を定量的に示す分析結果
- 意思決定者向けデータAPI

**優先度:** 中 (主要機能の次に実施)

### Phase 7: データ拡充・RAG機能強化・API最適化 (3週間)

**目標:** より精度の高い見積もりのためのデータ拡充とAPI性能最適化

- [ ] 過去プロジェクトデータの追加登録
- [ ] システムカテゴリと質問テンプレートの追加・洗練
- [ ] ベクトル検索の最適化
- [ ] AIプロンプトのチューニング
- [ ] 類似機能の重複排除ロジックの改善
- [ ] 業界ベンチマークデータの拡充
- [ ] API応答時間の最適化
- [ ] サーバーレス関数の最適化 (コールドスタート対策)
- [ ] API使用量に応じた自動スケーリング設定
- [ ] データキャッシュ戦略の実装
- [ ] アノテーションツールの実装 (人間によるフィードバック収集)
- [ ] モデル評価・改善サイクルの確立

**成果物:**
- 拡充されたプロジェクトテンプレートデータ
- 改善されたRAG検索精度
- より正確な見積もり結果
- 最適化されたAPI性能

**優先度:** 高 (継続的なサービス改善に重要)

### Phase 8: APIテスト・評価・改善 (3週間)

**目標:** API機能のテストと評価、フィードバックに基づく改善

- [ ] API統合テストの実施
- [ ] 負荷テストの実施
- [ ] セキュリティテストの実施
- [ ] パートナー企業によるAPIテスト
- [ ] クライアントSDKの開発 (JavaScript, Python)
- [ ] サンプルアプリケーションの開発
- [ ] APIドキュメントの完成
- [ ] Swagger UIのデプロイ
- [ ] エラー処理の改善
- [ ] パフォーマンス評価と最適化
- [ ] バグ修正と機能調整
- [ ] セキュリティ監査の実施
- [ ] フィードバック収集と分析

**成果物:**
- テストレポート
- APIクライアントSDK
- 改善計画
- 完全なAPIドキュメント
- ベータ版リリース

**優先度:** 高 (リリース前の品質担保)

### Phase 9: 本番リリース・運用開始 (1.5週間)

**目標:** 本番環境へのデプロイと初期運用

- [ ] 本番環境の構築 (Vercel)
- [ ] カスタムドメイン設定
- [ ] SSL証明書の設定
- [ ] 本番Supabase環境の構築
- [ ] Vercel環境変数の設定
- [ ] デプロイパイプラインの構築
- [ ] 初期API Keyの発行
- [ ] API利用規約の作成
- [ ] 運用マニュアルの作成
- [ ] モニタリングとアラートの設定
- [ ] バックアップ設定
- [ ] 継続的なパフォーマンスモニタリング体制の構築
- [ ] APIサポート体制の確立

**成果物:**
- 本番運用APIシステム
- 運用マニュアル
- API利用規約と開発者ドキュメント

**優先度:** 高 (Phase 8完了次第)

## 修正後の総合スケジュール

| フェーズ | 内容 | 期間 | 開始日 | 完了予定日 |
|---------|------|------|-------|-----------|
| Phase 1 | 環境構築・基盤開発・API設計 | 2.5週間 | 2024-04-15 | 2024-05-02 |
| Phase 2 | 初期要件入力・質問生成API実装 | 2週間 | 2024-05-03 | 2024-05-16 |
| Phase 3 | 機能洗い出し・コスト概算API実装 | 3週間 | 2024-05-17 | 2024-06-06 |
| Phase 4 | 機能選択・見積書出力API実装 | 2.5週間 | 2024-06-07 | 2024-06-24 |
| Phase 5 | ビジネス分析APIの実装 | 2.5週間 | 2024-06-25 | 2024-07-11 |
| Phase 7 | データ拡充・RAG機能強化・API最適化 | 3週間 | 2024-07-12 | 2024-08-01 |
| Phase 8 | APIテスト・評価・改善 | 3週間 | 2024-08-02 | 2024-08-22 |
| Phase 9 | 本番リリース・運用開始 | 1.5週間 | 2024-08-23 | 2024-09-06 |

**合計開発期間:** 約20週間（約4.5ヶ月）※Phase 6を除外したため短縮

## リスクと対策

1. **AIの質問・機能抽出精度**
   - リスク: 精度が低く、使い物にならない質問や見積もりが生成される
   - 対策: 十分な初期データ登録と継続的なプロンプト調整、人間によるレビューステップの組み込み

2. **API性能とスケーラビリティ**
   - リスク: 高負荷時のレスポンス遅延やエラー発生
   - 対策: サーバーレス関数の最適化、キャッシュ戦略の実装、適切なレート制限設定

3. **Vercelデプロイの制約**
   - リスク: サーバーレス環境による処理時間や接続の制約
   - 対策: 長時間処理の分割、バックグラウンドジョブの実装、適切なタイムアウト設定

4. **過去データの質と量**
   - リスク: 十分な量の高品質な過去プロジェクトデータがない
   - 対策: 一般的なシステム機能と標準的な工数データを先行登録、徐々に実績データで拡充

5. **API統合の複雑さ**
   - リスク: 外部システムとの統合が複雑で時間がかかる
   - 対策: 明確なAPIドキュメント、SDKの提供、サンプルコードの充実

6. **セキュリティリスク**
   - リスク: API Keyの漏洩、不正アクセス
   - 対策: 厳格なアクセス制御、適切なAPI Key管理、セキュリティ監査の定期実施

7. **ビジネス分析の精度**
   - リスク: ROIやコスト効率化の予測精度が低い
   - 対策: 業界データの継続的な収集と検証、フィードバックループの構築

8. **API互換性の維持**
   - リスク: API変更によるクライアント側の問題発生
   - 対策: バージョニング戦略の適用、下位互換性の維持、変更管理プロセスの確立

9. **RLS設定の複雑さ**
   - リスク: 複雑なRLSポリシーによる意図しないデータアクセス制限
   - 対策: テスト環境での徹底的な検証、セッション管理機能の最適化

10. **TypeScript APIの保守性**
    - リスク: 型定義の不整合やAPI設計の不備によるバグ
    - 対策: 厳格な型チェック、統一的なエラーハンドリング、包括的なテストカバレッジ

11. **Express互換性の問題**
    - リスク: Expressのバージョン間の互換性問題により機能が正常に動作しない
    - 対策: 安定版バージョンの使用、徹底的なテスト、必要に応じて回避策の実装

12. **匿名ユーザーのデータセキュリティ**
    - リスク: RLSを無効化することによるデータ漏洩リスク
    - 対策: 適切なセッション管理、データアクセス監査、カスタムRLSポリシーの段階的実装

---

**補足:**
このマイルストーンはあくまで計画であり、実装の進捗や発見される課題によって調整が必要です。UIの実装は別プロジェクトで行われるため、このプロジェクトはAPIのみに注力します。TypeScriptによる型安全なAPIの実装を通じて、高品質なサービス提供を目指します。